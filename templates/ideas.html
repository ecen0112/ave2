{% extends "base.html" %}
{% block title %}Date Ideas - Our Journey{% endblock %}
{% block content %}
<h1 class="page-title">Date Ideas</h1>

<div class="content-grid">
  <!-- Add Idea Card -->
  <article class="card-3d">
    <div class="card-inner">
      <h3>Add New Idea</h3>
      {% if session.get('role') == 'erl' or session.get('role') == 'love' %}
        <form method="post" class="stack add-idea-form" novalidate>
          <input name="idea" type="text" placeholder="A romantic idea..." required>
          <select name="status" class="status-select" required>
            <option value="" disabled selected>Select Status</option>
            <option value="Planned">Planned</option>
            <option value="Completed">Completed</option>
          </select>
          <button class="btn add-btn" type="submit">Add Idea</button>
        </form>
      {% else %}
        <p class="muted">Only admins can add ideas. Sign in as BUNBUN to add.</p>
      {% endif %}
    </div>
  </article>

  <!-- All Ideas Card -->
  <article class="card-3d" style="grid-column: 1 / -1;">
    <div class="card-inner">
      <h3>All Ideas</h3>
      <div class="search-sort-container">
        <input type="text" id="idea-search" class="search-input" placeholder="Search ideas..." onkeyup="filterIdeas()">
        <select id="idea-sort" class="sort-select" onchange="sortIdeas()">
          <option value="" disabled selected>Sort By</option>
          <option value="text-asc">A-Z</option>
          <option value="text-desc">Z-A</option>
          <option value="status">Status</option>
        </select>
      </div>
      {% if ideas %}
        <div class="grid idea-list" id="idea-list">
          {% for idea in ideas %}
            <div class="idea-card" data-text="{{ idea.text|lower }}" data-status="{{ idea.status|lower }}">
              <div class="idea-content">
                <h4 class="idea-text">{{ idea.text }}</h4>
                <span class="idea-status {{ idea.status|lower }}">{{ idea.status }}</span>
                <div class="idea-actions">
                  <button type="button" class="btn toggle-btn" onclick="toggleStatus(this, '{{ loop.index0 }}', '{{ idea.status }}')">
                    {% if idea.status == 'Completed' %}Mark Planned{% else %}Mark Completed{% endif %}
                  </button>
                  <form method="post" action="{{ url_for('edit_idea', idx=loop.index0) }}" class="edit-form" style="display:inline;">
                    <input type="hidden" name="new_text" value="">
                    <button type="button" class="btn edit-btn" onclick="editIdea(this, '{{ loop.index0 }}')">Edit</button>
                  </form>
                  <form method="post" action="{{ url_for('delete_idea', idx=loop.index0) }}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this idea?')">
                    <button class="btn delete-btn" type="submit">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No ideas yet.</p>
      {% endif %}
    </div>
  </article>
</div>

<style>
  .content-grid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(200px, .5fr));
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 24px;
    text-align: center;
    animation: fadeIn 0.5s ease-out;
  }

  .card-3d {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
    border-radius: 18px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
    padding: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card-3d:hover {
    transform: translateY(-5px);
    box-shadow: 0 16px 36px rgba(0, 0, 0, 0.25);
  }

  .card-inner {
    text-align: center;
  }

  .stack {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .add-idea-form input,
  .add-idea-form select {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    box-sizing: border-box;
  }

  .status-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ffffff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
  }

  .btn {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.3s ease, background 0.3s ease;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
  }

  .btn:hover {
    transform: translateY(-2px);
    background: linear-gradient(135deg, #ff4060, #8ba8e0);
  }

  .add-btn {
    background: linear-gradient(135deg, #4CAF50, #8BC34A);
  }

  .add-btn:hover {
    background: linear-gradient(135deg, #388E3C, #689F38);
  }

  .toggle-btn {
    background: linear-gradient(135deg, #ff9800, #ff5722);
    padding: 8px 15px;
    max-width: 150px;
  }

  .toggle-btn:hover {
    background: linear-gradient(135deg, #f57c00, #e64a19);
  }

  .edit-btn {
    background: linear-gradient(135deg, #2196F3, #42A5F5);
    padding: 8px 15px;
    max-width: 100px;
  }

  .edit-btn:hover {
    background: linear-gradient(135deg, #1976D2, #1E88E5);
  }

  .delete-btn {
    background: linear-gradient(135deg, #ff4060, #8ba8e0);
    padding: 8px 15px;
    max-width: 100px;
  }

  .delete-btn:hover {
    background: linear-gradient(135deg, #ff1a40, #6b88c0);
  }

  .muted {
    color: #cccccc;
    font-style: italic;
  }

  .search-sort-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .search-input, .sort-select {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    max-width: 300px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  .idea-list {
    margin-top: 15px;
  }

  .idea-card {
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid var(--accent);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .idea-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  .idea-content {
    flex-grow: 1;
  }

  .idea-text {
    font-size: 1.1rem;
    color: #ffffff;
    margin: 0 0 10px 0;
    word-wrap: break-word;
  }

  .idea-status {
    font-size: 0.9rem;
    padding: 4px 8px;
    border-radius: 5px;
    display: inline-block;
    margin-bottom: 10px;
  }

  .idea-status.planned {
    background: #4CAF50;
    color: white;
  }

  .idea-status.completed {
    background: #2196F3;
    color: white;
  }

  .idea-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  .edit-form input[type="hidden"] {
    display: none;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
    .btn {
      padding: 8px 16px;
      max-width: 150px;
    }
    .grid {
      grid-template-columns: 1fr;
    }
    .idea-actions {
      flex-direction: column;
    }
    .toggle-btn, .edit-btn, .delete-btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 1.5rem;
    }
    .btn {
      padding: 6px 12px;
      max-width: 120px;
    }
    .idea-text {
      font-size: 1rem;
    }
    .idea-status {
      font-size: 0.8rem;
    }
  }
</style>

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editButtons = document.querySelectorAll('.edit-btn');
    editButtons.forEach(button => {
      button.addEventListener('click', () => editIdea(button));
    });
  });

  function filterIdeas() {
    const input = document.getElementById("idea-search").value.toLowerCase();
    const cards = document.getElementsByClassName("idea-card");
    for (let card of cards) {
      const text = card.dataset.text;
      const status = card.dataset.status;
      if (text.includes(input) || status.includes(input)) {
        card.style.display = "";
      } else {
        card.style.display = "none";
      }
    }
  }

  function sortIdeas() {
    const select = document.getElementById("idea-sort");
    const value = select.value;
    const list = document.getElementById("idea-list");
    const cards = Array.from(list.getElementsByClassName("idea-card"));
    cards.sort((a, b) => {
      if (value === "text-asc") {
        return a.dataset.text.localeCompare(b.dataset.text);
      } else if (value === "text-desc") {
        return b.dataset.text.localeCompare(a.dataset.text);
      } else if (value === "status") {
        return a.dataset.status.localeCompare(b.dataset.status);
      }
      return 0;
    });
    list.innerHTML = "";
    cards.forEach(card => list.appendChild(card));
  }

  function editIdea(button, index) {
    const card = button.closest(".idea-card");
    const textElement = card.querySelector(".idea-text");
    const currentText = textElement.textContent;
    const form = card.querySelector(".edit-form");
    const input = form.querySelector("input[name='new_text']");

    if (button.textContent === "Edit") {
      const textarea = document.createElement("textarea");
      textarea.value = currentText;
      textarea.rows = 2;
      textarea.style.width = "100%";
      textarea.style.padding = "5px";
      textarea.style.borderRadius = "5px";
      textarea.style.border = "1px solid var(--accent)";
      textarea.style.background = "rgba(255, 255, 255, 0.1)";
      textarea.style.color = "#ffffff";
      textElement.replaceWith(textarea);
      button.textContent = "Save";
    } else {
      const textarea = card.querySelector("textarea");
      const newText = textarea.value.trim();
      if (newText && newText !== currentText) {
        input.value = newText;
        form.submit();
      } else if (!newText) {
        alert("Idea cannot be empty!");
        return;
      } else {
        textarea.replaceWith(textElement);
        textElement.textContent = currentText;
        button.textContent = "Edit";
      }
    }
  }

  function toggleStatus(button, index, currentStatus) {
    const newStatus = currentStatus === 'Completed' ? 'Planned' : 'Completed';
    const form = document.createElement('form');
    form.method = 'post';
    form.action = '{{ url_for("toggle_idea_status", idx=0) }}'.replace('0', index);
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'new_status';
    input.value = newStatus;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
</script>
{% endblock %}
{% endblock %}